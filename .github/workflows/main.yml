name: Pi-hole 完整 Magisk 模块（全新干净版）

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-24.04
    steps:
      - name: 安装工具
        run: sudo apt-get update && sudo apt-get install -y wget curl unzip zip

      - name: 下载官方 pihole-FTL-arm64
        run: wget -q https://github.com/pi-hole/FTL/releases/latest/download/pihole-FTL-arm64 -O pihole-FTL && chmod +x pihole-FTL

      - name: 构建 Magisk 模块
        run: |
          MODULE="pihole-full-magisk-clean"
          mkdir -p $MODULE/system/bin $MODULE/etc/pihole $MODULE/www $MODULE/log $MODULE/customize.d

          # FTL
          cp pihole-FTL $MODULE/system/bin/pihole-FTL
          chmod 755 $MODULE/system/bin/pihole-FTL

          # Pi-hole 完整脚本
          git clone --depth=1 https://github.com/pi-hole/pi-hole.git src
          cp src/pihole $MODULE/system/bin/pihole
          cp src/gravity.sh $MODULE/etc/pihole/
          chmod +x $MODULE/system/bin/pihole $MODULE/etc/pihole/gravity.sh

          # Zashboard (mihomo版) + 预适配 Pi-hole API
          wget -q https://github.com/Zephyruso/zashboard/releases/latest/download/dist.zip -O z.zip
          unzip z.zip -d $MODULE/www
          # 适配 Pi-hole API
          find $MODULE/www -name "*.js" -exec sed -i 's|http[^"]*9090|http://127.0.0.1:5555/api|g' {} \;
          find $MODULE/www -name "*.js" -exec sed -i 's|/control/|/api/|g' {} \;
          echo 'window.API_BASE="/api";' >> $MODULE/www/index.html

          # module.prop
          cat > $MODULE/module.prop << EOF
          id=pihole-full-clean
          name=Pi-hole 完整版（官方FTL + Zashboard）Magisk
          version=$(date +%Y%m%d)
          versionCode=$(date +%s)
          author=Clean Build
          description=全新构建版，解决启动、端口、Zashboard适配问题
          EOF

          # post-fs-data.sh（关键：创建目录 + 复制配置）
          cat > $MODULE/post-fs-data.sh << 'EOF'
          #!/system/bin/sh
          mkdir -p /etc/pihole /data/adb/modules/pihole-full-clean/log
          cp -f /data/adb/modules/pihole-full-clean/etc/pihole/pihole.toml /etc/pihole/pihole.toml
          chmod 755 /data/adb/modules/pihole-full-clean/system/bin/pihole-FTL
          setcap 'cap_net_bind_service=+ep' /data/adb/modules/pihole-full-clean/system/bin/pihole-FTL 2>/dev/null || true
          EOF
          chmod 755 $MODULE/post-fs-data.sh

          # service.sh（极简可靠）
          cat > $MODULE/service.sh << 'EOF'
          #!/system/bin/sh
          LOG=/data/adb/modules/pihole-full-clean/service.log
          echo "=== FTL 启动 $(date) ===" > $LOG
          /data/adb/modules/pihole-full-clean/system/bin/pihole-FTL >> /data/adb/modules/pihole-full-clean/log/FTL.log 2>&1 &
          echo "FTL PID: $!" >> $LOG
          EOF
          chmod 755 $MODULE/service.sh

          # pihole.toml
          cat > $MODULE/etc/pihole/pihole.toml << 'EOF'
          [webserver]
            port = "5555"
            interface = "0.0.0.0"
            webroot = "/data/adb/modules/pihole-full-clean/www"
          [dns]
            port = 53
            blocking = true
            block = "NXDOMAIN"
            dnssec = false
          [files]
            log = "/data/adb/modules/pihole-full-clean/log/FTL.log"
          EOF

          cd $MODULE
          zip -r ../pihole-full-magisk-clean.zip .
          cd ..

      - name: 上传 Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: clean-${{ github.run_number }}
          name: Pi-hole 完整 Magisk 模块（全新构建版）
          files: pihole-full-magisk-clean.zip
          draft: false
