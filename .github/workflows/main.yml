name: Pi-hole 完整版 Magisk 模块（官方 FTL + Zashboard）

on:
  schedule:
    - cron: '0 16 * * *'   # 北京时间每天 00:00 自动更新最新版
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-24.04
    steps:
      - name: 安装工具
        run: sudo apt-get update && sudo apt-get install -y wget curl unzip zip

      # ==================== 下载官方最新 pihole-FTL-arm64 ====================
      - name: 下载官方 pihole-FTL-arm64
        run: |
          wget -q https://github.com/pi-hole/FTL/releases/latest/download/pihole-FTL-arm64 -O pihole-FTL
          chmod +x pihole-FTL
          echo "✅ 官方 FTL 下载完成，大小：$(ls -lh pihole-FTL | awk '{print $5}')"

      # ==================== 打包完整 Pi-hole Magisk 模块 ====================
      - name: 构建 Magisk 模块（完整 Pi-hole + Zashboard）
        run: |
          MODULE="pihole-full-magisk"
          mkdir -p $MODULE/system/bin $MODULE/etc/pihole $MODULE/www

          # 官方 FTL
          cp pihole-FTL $MODULE/system/bin/pihole-FTL
          chmod 755 $MODULE/system/bin/pihole-FTL

          # 完整 Pi-hole 脚本（gravity 更新、pihole 命令全部可用）
          git clone --depth=1 https://github.com/pi-hole/pi-hole.git pihole-src
          cp pihole-src/pihole $MODULE/system/bin/pihole
          cp pihole-src/gravity.sh $MODULE/etc/pihole/
          cp -r pihole-src/advanced/Scripts/* $MODULE/etc/pihole/ 2>/dev/null || true
          chmod +x $MODULE/system/bin/pihole $MODULE/etc/pihole/gravity.sh

          # Zashboard 静态 Web（现代漂亮界面）
          wget -q https://github.com/Zephyruso/zashboard/releases/latest/download/dist.zip -O z.zip
          unzip z.zip -d $MODULE/www
          rm -rf $MODULE/www/src 2>/dev/null || true

          # module.prop
          cat > $MODULE/module.prop << EOF
          id=pihole-full-official
          name=Pi-hole 完整版（官方 FTL + Zashboard）Magisk
          version=$(date +%Y%m%d)
          versionCode=$(date +%s)
          author=社区定制
          description=官方 pihole-FTL + 完整脚本 + Zashboard，开机自启，gravity 更新可用
          EOF

          # service.sh（开机自动启动）
          cat > $MODULE/service.sh << 'EOF'
          #!/system/bin/sh
          /system/bin/pihole-FTL -d --webserver --webroot /data/adb/modules/pihole-full-official/www &
          echo "Pi-hole 已启动 → 访问 http://127.0.0.1/admin"
          EOF
          chmod 755 $MODULE/service.sh

          # post-fs-data.sh（权限 + 配置）
          cat > $MODULE/post-fs-data.sh << 'EOF'
          #!/system/bin/sh
          mkdir -p /etc/pihole
          cp -f /data/adb/modules/pihole-full-official/etc/pihole/* /etc/pihole/ 2>/dev/null || true
          chmod 755 /system/bin/pihole /system/bin/pihole-FTL
          EOF
          chmod 755 $MODULE/post-fs-data.sh

          # 预置你之前推荐的广告规则
          cat > $MODULE/etc/pihole/adlists.list << 'EOF'
          https://gitlab.com/hagezi/mirror/-/raw/main/dns-blocklists/adblock/pro.txt
          https://gitlab.com/hagezi/mirror/-/raw/main/dns-blocklists/adblock/multi.txt
          https://dbl.oisd.nl/
          https://v.firebog.net/hosts/AdguardDNS.txt
          EOF

          # 打包 ZIP
          cd $MODULE
          zip -r ../pihole-full-magisk-module.zip .
          cd ..

      - name: 上传到 Releases（自动）
        uses: softprops/action-gh-release@v2
        with:
          tag_name: full-magisk-${{ github.run_number }}
          name: Pi-hole 完整版 Magisk 模块（官方 FTL） ${{ github.run_number }}
          files: pihole-full-magisk-module.zip
          draft: false

      - name: 上传 Artifact
        uses: actions/upload-artifact@v4
        with:
          name: pihole-full-magisk
          path: pihole-full-magisk-module.zip
