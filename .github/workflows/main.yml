name: Pi-hole FTL 全静态 Android 一键编译（完全自动）

on:
  # 完全自动：每天北京时间 00:00 自动编译最新版
  schedule:
    - cron: '0 16 * * *'   # UTC 16:00 = 北京时间 00:00

  # 手动触发（第一次或想立即编译时使用）
  workflow_dispatch:
    inputs:
      branch:
        description: 'FTL 分支'
        required: true
        default: 'development'
      arch:
        description: '手机架构（推荐 aarch64）'
        required: true
        default: 'aarch64'
        type: choice
        options:
          - aarch64
          - armv7
      disable_dnssec:
        description: '关闭 DNSSEC（手机强烈推荐，减少崩溃）'
        required: false
        default: true
        type: boolean
      optimize:
        description: '优化级别'
        required: false
        default: 'Os'
        type: choice
        options:
          - Os
          - O3

permissions:
  contents: write   # 自动创建 Release 需要

jobs:
  build:
    name: 编译 ${{ inputs.arch || 'aarch64' }} 全静态 musl
    runs-on: ubuntu-24.04

    steps:
      - name: Checkout pi-hole/FTL（自动 clone，无需 Fork）
        uses: actions/checkout@v4
        with:
          repository: pi-hole/FTL
          ref: ${{ inputs.branch || 'development' }}

      - name: 安装基础工具
        run: sudo apt-get update -qq && sudo apt-get install -y wget curl tar gzip make cmake file patchelf binutils git

      # ==================== musl 交叉工具链 ====================
      - name: 下载 musl 交叉工具链
        run: |
          ARCH="${{ inputs.arch || 'aarch64' }}"
          if [ "$ARCH" = "armv7" ]; then ARCH="arm"; fi
          wget -q "https://github.com/userdocs/musl-cross-make/releases/latest/download/${ARCH}-linux-musl-cross.tgz" -O tc.tgz
          sudo tar -xzf tc.tgz -C /opt/
          sudo mv /opt/*-linux-musl-cross /opt/musl-toolchain
          echo "/opt/musl-toolchain/bin" >> $GITHUB_PATH

      # ==================== 完整静态依赖预构建 ====================
      - name: 编译所有静态依赖（GMP + Nettle + libidn2 + SQLite3）
        run: |
          PREFIX="/opt/musl-deps"
          TC_PREFIX="${{ inputs.arch || 'aarch64' }}-linux-musl"
          if [ "${{ inputs.arch || 'aarch64' }}" = "armv7" ]; then TC_PREFIX="arm-linux-musleabihf"; fi
          mkdir -p $PREFIX/src && cd $PREFIX/src

          # GMP
          wget -q https://gmplib.org/download/gmp/gmp-6.3.0.tar.xz && tar xf gmp-6.3.0.tar.xz && cd gmp-6.3.0
          ./configure --host=$TC_PREFIX --prefix=\( PREFIX --enable-static --disable-shared --disable-assembly CFLAGS="- \){{ inputs.optimize || 'Os' }} -static -fPIC"
          make -j$(nproc) && make install && cd ..

          # Nettle
          wget -q https://ftp.gnu.org/gnu/nettle/nettle-3.10.tar.gz && tar xf nettle-3.10.tar.gz && cd nettle-3.10
          ./configure --host=$TC_PREFIX --prefix=\( PREFIX --enable-static --disable-shared --disable-openssl CFLAGS="- \){{ inputs.optimize || 'Os' }} -static -fPIC" LDFLAGS="-static"
          make -j$(nproc) && make install && cd ..

          # libunistring + libidn2
          wget -q https://ftp.gnu.org/gnu/libunistring/libunistring-1.3.tar.xz && tar xf libunistring-1.3.tar.xz && cd libunistring-1.3
          ./configure --host=$TC_PREFIX --prefix=\( PREFIX --enable-static --disable-shared CFLAGS="- \){{ inputs.optimize || 'Os' }} -static -fPIC"
          make -j$(nproc) && make install && cd ..
          wget -q https://ftp.gnu.org/gnu/libidn/libidn2-2.3.7.tar.gz && tar xf libidn2-2.3.7.tar.gz && cd libidn2-2.3.7
          ./configure --host=$TC_PREFIX --prefix=\( PREFIX --enable-static --disable-shared --disable-doc CFLAGS="- \){{ inputs.optimize || 'Os' }} -static -fPIC"
          make -j$(nproc) && make install && cd ..

          # SQLite3
          wget -q https://www.sqlite.org/2025/sqlite-autoconf-3490100.tar.gz && tar xf sqlite-autoconf-3490100.tar.gz && cd sqlite-autoconf-3490100
          ./configure --host=$TC_PREFIX --prefix=\( PREFIX --enable-static --disable-shared CFLAGS="- \){{ inputs.optimize || 'Os' }} -static -fPIC"
          make -j$(nproc) && make install && cd ..

          echo "PKG_CONFIG_PATH=$PREFIX/lib/pkgconfig" >> $GITHUB_ENV
          echo "C_INCLUDE_PATH=$PREFIX/include" >> $GITHUB_ENV
          echo "LIBRARY_PATH=$PREFIX/lib" >> $GITHUB_ENV

      # ==================== 编译 pihole-FTL ====================
      - name: 设置环境并编译
        run: |
          TC_PREFIX="${{ inputs.arch || 'aarch64' }}-linux-musl"
          if [ "${{ inputs.arch || 'aarch64' }}" = "armv7" ]; then TC_PREFIX="arm-linux-musleabihf"; fi
          export CC="${TC_PREFIX}-gcc"
          export CFLAGS="-${{ inputs.optimize || 'Os' }} -pipe -fomit-frame-pointer -static -static-libgcc -fPIC -I/opt/musl-deps/include"
          export LDFLAGS="-static -Wl,--gc-sections -L/opt/musl-deps/lib"
          export STATIC=true
          DNSSEC=${{ inputs.disable_dnssec == 'true' && 'OFF' || 'ON' }}

          mkdir build && cd build
          cmake .. \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_C_COMPILER=$CC \
            -DSTATIC=true \
            -DENABLE_DNSSEC=$DNSSEC \
            -DCMAKE_C_FLAGS="$CFLAGS" \
            -DCMAKE_EXE_LINKER_FLAGS="$LDFLAGS"
          cmake --build . --target pihole-FTL -- -j$(nproc)

          # 验证 & strip
          cd ..
          BINARY="build/pihole-FTL"
          $TC_PREFIX-strip --strip-all $BINARY 2>/dev/null || strip --strip-all $BINARY
          file $BINARY
          readelf -d $BINARY | grep -q NEEDED && echo "⚠️ 仍有动态链接" || echo "✅ 完全静态成功！"

          mv \( BINARY pihole-FTL-static-musl- \){{ inputs.arch || 'aarch64' }}-android

      
      - name: 上传到 Release（完全自动）
        uses: softprops/action-gh-release@v2
        with:
          tag_name: android-static-${{ github.run_number }}
          name: Pi-hole FTL 静态 Android ${{ inputs.arch || 'aarch64' }} - ${{ github.run_number }}
          files: |
            pihole-FTL-static-musl-${{ inputs.arch || 'aarch64' }}-android
            README-ANDROID.md
          draft: false
          prerelease: false

      - name: 上传 Artifact（备选下载）
        uses: actions/upload-artifact@v4
        with:
          name: pihole-FTL-static-android
          path: |
            pihole-FTL-static-musl-${{ inputs.arch || 'aarch64' }}-android
            README-ANDROID.md
